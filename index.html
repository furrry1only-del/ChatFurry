<!doctype html>
<html lang="uk">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ChatFury — OpenAI Chat</title>
  <style>
    body{margin:0;font-family:sans-serif;background:#0b0b0b;color:#fff}
    .wrap{min-height:100vh;display:flex;align-items:center;justify-content:center;padding:24px}
    .widget{width:420px;border-radius:14px;background:#111;box-shadow:0 12px 40px rgba(0,0,0,0.6);overflow:hidden}
    header{display:flex;justify-content:space-between;align-items:center;padding:12px;background:#1a1f24}
    .logo{font-weight:bold}
    .messages{height:340px;overflow:auto;padding:12px;display:flex;flex-direction:column;gap:12px}
    .bubble{padding:10px 14px;border-radius:12px;max-width:80%}
    .user{align-self:flex-end;background:#273042}
    .bot{align-self:flex-start;background:#1f242a}
    .composer{display:flex;gap:8px;padding:12px;background:#1a1f24}
    textarea{flex:1;min-height:44px;padding:8px;border-radius:8px;border:none;resize:none}
    button{padding:8px 12px;border-radius:8px;border:none;cursor:pointer}
    .modal-back{position:fixed;inset:0;background:rgba(0,0,0,0.6);display:none;align-items:center;justify-content:center}
    .modal{background:#222;padding:16px;border-radius:10px;width:320px;color:#fff}
    .row{margin-bottom:10px}
    label{display:block;margin-bottom:4px;font-size:14px}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="widget">
      <header>
        <div class="logo">⚡ ChatFury</div>
        <div>
          <button id="settingsBtn">⚙️</button>
        </div>
      </header>
      <div class="messages" id="messages"></div>
      <div class="composer">
        <textarea id="input" placeholder="Введи повідомлення..."></textarea>
        <button id="sendBtn">➤</button>
        <button id="stopBtn">⏹</button>
      </div>
    </div>
  </div>

  <!-- Modal settings -->
  <div class="modal-back" id="modal">
    <div class="modal">
      <h3>Налаштування</h3>
      <div class="row">
        <label>API Key</label>
        <textarea id="apiKeyInput" rows="2" style="width:100%"></textarea>
      </div>
      <div class="row">
        <label>Model</label>
        <select id="modelSelect">
          <option value="gpt-4">gpt-4</option>
          <option value="gpt-3.5-turbo" selected>gpt-3.5-turbo</option>
        </select>
      </div>
      <div class="row">
        <label>Temperature</label>
        <input id="temp" type="range" min="0" max="1" step="0.1" value="0.7"/>
      </div>
      <div style="text-align:right">
        <button id="closeSettings">Закрити</button>
        <button id="saveSettings">Зберегти</button>
      </div>
    </div>
  </div>

  <script>
    const messagesEl = document.getElementById('messages');
    const inputEl = document.getElementById('input');
    const sendBtn = document.getElementById('sendBtn');
    const stopBtn = document.getElementById('stopBtn');
    const modal = document.getElementById('modal');
    const settingsBtn = document.getElementById('settingsBtn');
    const apiKeyInput = document.getElementById('apiKeyInput');
    const modelSelect = document.getElementById('modelSelect');
    const tempInput = document.getElementById('temp');

    let abortController = null;

    // load saved settings
    apiKeyInput.value = localStorage.getItem('openai_key') || '';
    modelSelect.value = localStorage.getItem('openai_model') || 'gpt-3.5-turbo';
    tempInput.value = localStorage.getItem('openai_temp') || 0.7;

    settingsBtn.onclick = ()=> modal.style.display='flex';
    document.getElementById('closeSettings').onclick=()=> modal.style.display='none';
    document.getElementById('saveSettings').onclick=()=>{
      localStorage.setItem('openai_key', apiKeyInput.value.trim());
      localStorage.setItem('openai_model', modelSelect.value);
      localStorage.setItem('openai_temp', tempInput.value);
      modal.style.display='none';
    };

    function appendMessage(role,text){
      const div=document.createElement('div');
      div.className='bubble '+role;
      div.textContent=text;
      messagesEl.appendChild(div);
      messagesEl.scrollTop=messagesEl.scrollHeight;
    }

    async function sendMessage(){
      const text=inputEl.value.trim();
      if(!text) return;
      appendMessage('user',text);
      inputEl.value='';
      const key=localStorage.getItem('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');
      if(!key){appendMessage('bot','❗ Встав API ключ у налаштуваннях');return;}

      abortController = new AbortController();
      appendMessage('bot','...'); // placeholder
      try{
        const res=await fetch('https://api.openai.com/v1/chat/completions',{
          method:'POST',
          headers:{'Content-Type':'application/json','Authorization':'Bearer '+key},
          body:JSON.stringify({
            model: modelSelect.value,
            temperature: parseFloat(tempInput.value),
            messages:[{role:'user',content:text}]
          }),
          signal: abortController.signal
        });
        if(!res.ok){throw new Error(await res.text());}
        const data=await res.json();
        const reply=data.choices[0].message.content;
        messagesEl.lastChild.textContent=reply;
      }catch(err){
        messagesEl.lastChild.textContent='❗ Помилка: '+err.message;
      }
    }

    sendBtn.onclick=sendMessage;
    inputEl.addEventListener('keydown',e=>{
      if(e.key==='Enter'&&!e.shiftKey){e.preventDefault();sendMessage();}
    });
    stopBtn.onclick=()=>{if(abortController) abortController.abort();}
  </script>
</body>
</html>
