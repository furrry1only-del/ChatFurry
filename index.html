<!doctype html>
<html lang="uk">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ChatFury ‚Äî –ª–æ–∫–∞–ª—å–Ω–∏–π –≤—ñ–¥–∂–µ—Ç</title>
  <style>
    :root{
      --bg:#0b0b0b; --panel:#0f0f10; --muted:#9aa0a6; --accent:#fff;
      --user-bg:#2f2f2f; --bot-bg:#1f1f1f;
    }
    html,body{height:100%;margin:0;background:var(--bg);font-family:Inter, Roboto, Arial, sans-serif;color:var(--accent)}
    .app {
      display:flex; align-items:center; justify-content:center; height:100%;
      padding:24px;
    }
    .chatbox{
      width:380px; border-radius:14px; background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
      box-shadow: 0 10px 30px rgba(0,0,0,0.6); overflow:hidden; border:1px solid rgba(255,255,255,0.03);
    }
    .header{
      display:flex; align-items:center; justify-content:space-between; padding:18px 16px;
      border-bottom:1px solid rgba(255,255,255,0.02);
    }
    .brand{display:flex; gap:10px; align-items:center}
    .logo{width:34px;height:34px;border-radius:50%;background:linear-gradient(135deg,#222,#111);display:flex;align-items:center;justify-content:center;font-weight:700}
    .brand h1{font-size:16px;margin:0}
    .nav a{color:var(--muted); text-decoration:none; margin-left:12px; cursor:pointer; font-size:14px}
    .content{padding:14px; display:flex; flex-direction:column; gap:12px; min-height:380px}
    .messages{background:transparent; display:flex; flex-direction:column; gap:10px; max-height:300px; overflow:auto; padding-right:6px}
    .msg{padding:12px 14px; border-radius:12px; max-width:78%; line-height:1.35}
    .bot{background:var(--bot-bg); align-self:flex-start}
    .user{background:var(--user-bg); align-self:flex-end}
    .controls{display:flex; gap:8px; align-items:center}
    .input-row{display:flex; gap:8px; align-items:center; padding:8px 12px; border-top:1px solid rgba(255,255,255,0.02)}
    .input-row input{flex:1; padding:12px 14px; border-radius:24px; background:#131313; border:1px solid rgba(255,255,255,0.02); color:var(--accent); outline:none}
    .send-btn{padding:10px 12px;border-radius:10px; background:#262626;border:none;color:white; cursor:pointer}
    .small{font-size:13px;color:var(--muted)}
    .meta{display:flex;gap:8px;align-items:center}
    .select, .btn {background:#111;border:1px solid rgba(255,255,255,0.03);color:var(--muted);padding:6px 8px;border-radius:8px}
    .btn{cursor:pointer}
    .footer-row{display:flex; justify-content:space-between; align-items:center; padding:10px 14px; font-size:13px; color:var(--muted)}
    .typing{font-style:italic; color:var(--muted)}
    /* modal */
    .modal-back{position:fixed;inset:0;background:rgba(0,0,0,0.6);display:none;align-items:center;justify-content:center}
    .modal{background:#0b0b0b;border-radius:12px;padding:18px;width:360px;border:1px solid rgba(255,255,255,0.03)}
    .modal h3{margin:0 0 8px 0}
    .modal p{color:var(--muted);font-size:14px}
    .modal .close{margin-top:12px;display:flex;justify-content:flex-end}
    .linklike{color:var(--muted);cursor:pointer;text-decoration:underline}
  </style>
</head>
<body>
  <div class="app">
    <div class="chatbox" role="application" aria-label="ChatFury widget">
      <div class="header">
        <div class="brand">
          <div class="logo">‚ö°</div>
          <div>
            <h1>ChatFury</h1>
            <div class="small" id="langLabel">–ú–æ–≤–∞: auto</div>
          </div>
        </div>
        <div class="nav">
          <a id="aboutBtn">About</a>
          <a id="apiBtn">API</a>
        </div>
      </div>

      <div class="content">
        <div class="controls">
          <div class="meta">
            <select id="modelSelect" class="select" title="Model">
              <option value="gpt-3.5-turbo">gpt-3.5-turbo</option>
              <option value="gpt-4">gpt-4</option>
            </select>
            <button id="clearBtn" class="btn">Clear</button>
            <button id="saveBtn" class="btn">Export</button>
          </div>
        </div>

        <div class="messages" id="messages" aria-live="polite">
          <!-- messages go here -->
        </div>

        <div class="input-row">
          <input id="userInput" type="text" placeholder="Type a message..." autocomplete="off" />
          <button class="send-btn" id="sendBtn">‚û§</button>
        </div>
      </div>

      <div class="footer-row">
        <div class="small">–õ–æ–∫–∞–ª—å–Ω–∞ —ñ—Å—Ç–æ—Ä—ñ—è: <span id="count">0</span> –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω—å</div>
        <div class="small typing" id="status">&nbsp;</div>
      </div>
    </div>
  </div>

  <!-- About Modal -->
  <div class="modal-back" id="modalBack">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="aboutTitle">
      <h3 id="aboutTitle">About ChatFury</h3>
      <p>
        –õ–æ–∫–∞–ª—å–Ω–∏–π UI-–≤—ñ–∂–µ—Ç —è–∫–∏–π –ø—ñ–¥–∫–ª—é—á–∞—î—Ç—å—Å—è –¥–æ OpenAI. –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –Ω–∞–º–∞–≥–∞—î—Ç—å—Å—è –∞–¥–∞–ø—Ç—É–≤–∞—Ç–∏—Å—è –ø—ñ–¥ –º–æ–≤—É –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞
        —ñ —à—Ç–æ–≤—Ö–∞—î –≤—ñ–¥–ø–æ–≤—ñ–¥—å —É —Ç—ñ–π –º–æ–≤—ñ. –Ü—Å—Ç–æ—Ä—ñ—è –∑–±–µ—Ä—ñ–≥–∞—î—Ç—å—Å—è –≤ localStorage.
      </p>
      <div class="close"><button id="closeModal" class="btn">Close</button></div>
    </div>
  </div>

  <!-- API Modal -->
  <div class="modal-back" id="apiModalBack">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="apiTitle">
      <h3 id="apiTitle">API / –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è</h3>
      <p class="small">
        <strong>–î–µ –≤—Å—Ç–∞–≤–∏—Ç–∏ –∫–ª—é—á OpenAI:</strong><br>
        –£ —Ñ–∞–π–ª—ñ –Ω–∏–∂—á–µ –∑–Ω–∞–π–¥–µ—à –∫–æ–Ω—Å—Ç–∞–Ω—Ç—É <code>OPENAI_API_KEY</code>. –ó–∞–º—ñ–Ω–∏ <code>YOUR_API_KEY_HERE</code> –Ω–∞ —Å–≤—ñ–π –∫–ª—é—á.
        <br><br>
        <strong>–í–ê–ñ–õ–ò–í–û:</strong> –î–ª—è –±–µ–∑–ø–µ–∫–∏ –Ω–∞ –ø—Ä–æ–¥–∞–∫—à–Ω—ñ —Ä–µ–∫–æ–º–µ–Ω–¥—É—î—Ç—å—Å—è –Ω–µ –≤—Å—Ç–∞–≤–ª—è—Ç–∏ –∫–ª—é—á —É —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥ ‚Äî —Ä–æ–±–∏ –ø—Ä–æ–∫—Å—ñ-–∑–∞–ø–∏—Ç —á–µ—Ä–µ–∑ —Å–≤—ñ–π –±–µ–∫–µ–Ω–¥.
      </p>

      <p class="small">–ê —Ç–∞–∫–æ–∂:</p>
      <ul class="small" style="color:var(--muted); padding-left:18px">
        <li>–ú–æ–∂–µ—à –≤–∏–±—Ä–∞—Ç–∏ –º–æ–¥–µ–ª—å –∑–≤–µ—Ä—Ö—É</li>
        <li>–ù–∞—Ç–∏—Å–Ω–∏ Export, —â–æ–± –∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ —ñ—Å—Ç–æ—Ä—ñ—é —á–∞—Ç—É (JSON)</li>
      </ul>
      <div style="margin-top:12px" class="close"><button id="closeApi" class="btn">Close</button></div>
    </div>
  </div>

  <script>
    /***********************
     * üîë –°–Æ–î–ò –í–°–¢–ê–í –°–í–Ü–ô OPENAI API KEY
     * (—Ç—ñ–ª—å–∫–∏ —è–∫—â–æ —Ç–µ—Å—Ç—É—î—à –ª–æ–∫–∞–ª—å–Ω–æ; —É –ø—Ä–æ–¥–∞–∫—à–Ω—ñ –ù–ï –≤—Å—Ç–∞–≤–ª—è–π –∫–ª—é—á —É —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥)
     ***********************/
    const OPENAI_API_KEY = "YOUR_API_KEY_HERE";

    /***********************
     * –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è / state
     ***********************/
    const messagesEl = document.getElementById('messages');
    const userInput = document.getElementById('userInput');
    const sendBtn = document.getElementById('sendBtn');
    const modelSelect = document.getElementById('modelSelect');
    const langLabel = document.getElementById('langLabel');
    const statusEl = document.getElementById('status');
    const countEl = document.getElementById('count');

    let conversation = loadConversation(); // –º–∞—Å–∏–≤ –æ–±'—î–∫—Ç—ñ–≤ {role, content}
    renderConversation();
    updateCount();

    // –ê–≤—Ç–æ–≤–∏–∑–Ω–∞—á–µ–Ω–Ω—è –º–æ–≤–∏ (–ø—Ä–æ—Å—Ç–∞): –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î browser locale + –ø–µ—Ä–µ–≤—ñ—Ä–∫—É –Ω–∞ –∫–∏—Ä–∏–ª–∏—Ü—é —É –ø–µ—Ä—à–æ–º—É –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—ñ
    function detectLanguageFromText(text) {
      if (!text) return navigator.language || 'en';
      // –Ø–∫—â–æ —î –∫–∏—Ä–∏–ª–∏—á–Ω—ñ —Å–∏–º–≤–æ–ª–∏ ‚Äî –ø—Ä–∏–ø—É—Å–∫–∞—î–º–æ —É–∫—Ä–∞—ó–Ω—Å—å–∫–∞/—Ä–æ—Å—ñ–π—Å—å–∫–∞
      if (/[–ê-–Ø–∞-—è–Å—ë–á—ó–Ü—ñ–Ñ—î“ê“ë]/.test(text)) {
        // —è–∫—â–æ —î —Å–ø–µ—Ü–∏—Ñ—ñ—á–Ω–∞ '—ó' –∞–±–æ '—î' –∞–±–æ '“ë' —Å–∫–æ—Ä—ñ—à–µ –∑–∞ –≤—Å–µ —É–∫—Ä–∞—ó–Ω—Å—å–∫–∞
        if (/[—ó–Ñ—î“ê“ë–á—ñ–Ü]/.test(text)) return 'uk';
        return 'ru';
      }
      // –ª–∞—Ç–∏–Ω–∏—Ü—è - –±–µ—Ä–µ–º–æ –±—Ä–∞—É–∑–µ—Ä–Ω—É –ª–æ–∫–∞–ª—å
      const nav = (navigator.language || 'en').split('-')[0];
      return nav || 'en';
    }

    function getUserLanguage() {
      // –Ø–∫—â–æ –≤ —ñ—Å—Ç–æ—Ä—ñ—ó —î user –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è ‚Äî –∞–Ω–∞–ª—ñ–∑—É—î–º–æ –ø–µ—Ä—à–µ
      const firstUser = conversation.find(m=>m.role==='user');
      const guessed = detectLanguageFromText(firstUser ? firstUser.content : '');
      return guessed;
    }

    function setLangLabel() {
      const lng = getUserLanguage();
      langLabel.textContent = '–ú–æ–≤–∞: ' + (lng === 'uk' ? '–£–∫—Ä–∞—ó–Ω—Å—å–∫–∞' : lng === 'ru' ? '–†–æ—Å—ñ–π—Å—å–∫–∞' : lng);
    }

    setLangLabel();

    /***********************
     * UI helpers
     ***********************/
    function addMessageToDOM(text, role) {
      const d = document.createElement('div');
      d.className = 'msg ' + (role === 'user' ? 'user' : 'bot');
      d.textContent = text;
      messagesEl.appendChild(d);
      messagesEl.scrollTop = messagesEl.scrollHeight;
    }

    function renderConversation() {
      messagesEl.innerHTML = '';
      if (conversation.length === 0) {
        addMessageToDOM("How can I help you?", 'bot');
        conversation.push({role:'system', content: defaultSystemPrompt()});
        saveConversation();
        updateCount();
        return;
      }
      conversation.forEach(m => {
        // system messages are hidden
        if (m.role === 'system') return;
        addMessageToDOM(m.content, m.role);
      });
    }

    function updateCount() {
      const count = conversation.filter(m => m.role !== 'system').length;
      countEl.textContent = count;
    }

    function appendAndSave(role, content) {
      conversation.push({role, content});
      saveConversation();
      updateCount();
    }

    function clearConversation() {
      conversation = [];
      localStorage.removeItem('chatfury_history_v1');
      renderConversation();
      updateCount();
    }

    function saveConversation() {
      try {
        localStorage.setItem('chatfury_history_v1', JSON.stringify(conversation));
      } catch (e) {
        console.warn('Cannot save conversation', e);
      }
    }

    function loadConversation() {
      try {
        const raw = localStorage.getItem('chatfury_history_v1');
        if (!raw) return [];
        return JSON.parse(raw);
      } catch (e) {
        return [];
      }
    }

    /***********************
     * System prompt + language adaptation
     ***********************/
    function defaultSystemPrompt() {
      // –°–∏—Å—Ç–µ–º–Ω–∏–π prompt —è–∫–∏–π –≥–æ–≤–æ—Ä–∏—Ç—å –º–æ–¥–µ–ª—ñ –≤—ñ–¥–ø–æ–≤—ñ–¥–∞—Ç–∏ –Ω–∞ –º–æ–≤—ñ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞
      const uiLang = getUserLanguage();
      let instruct = "You are a helpful assistant.";
      instruct += " Always respond in the user's language.";
      if (uiLang === 'uk') instruct += " Respond in Ukrainian.";
      else if (uiLang === 'ru') instruct += " Respond in Russian.";
      else instruct += ` Respond in ${uiLang}.`;
      instruct += " Keep answers clear and concise.";
      return instruct;
    }

    // –Ø–∫—â–æ –Ω–µ–º–∞—î system message ‚Äî –¥–æ–¥–∞–º–æ –π–æ–≥–æ
    (function ensureSystem() {
      if (!conversation.some(m => m.role === 'system')) {
        conversation.unshift({role:'system', content: defaultSystemPrompt()});
        saveConversation();
      }
    })();

    /***********************
     * Sending to OpenAI
     ***********************/
    async function sendMessage() {
      const text = userInput.value.trim();
      if (!text) return;
      // –î–æ–¥–∞—Ç–∏ –ª–æ–∫–∞–ª—å–Ω–æ
      appendAndSave('user', text);
      addMessageToDOM(text, 'user');
      userInput.value = '';
      setLangLabel();

      // update status
      status('Sending‚Ä¶');

      // –§–æ—Ä–º—É—î–º–æ –º–∞—Å–∏–≤ messages –¥–ª—è API (–≤–∫–ª—é—á–Ω–æ –∑ system)
      const messagesForAPI = conversation.slice(); // shallow copy
      // –ü–µ—Ä–µ–¥ –≤–∏–∫–ª–∏–∫–æ–º ‚Äî –æ–Ω–æ–≤–∏–º–æ system —â–æ–± –≥–∞—Ä–∞–Ω—Ç—É–≤–∞—Ç–∏ –∞–∫—Ç—É–∞–ª—å–Ω—É –º–æ–≤—É
      const sysIndex = messagesForAPI.findIndex(m=>m.role==='system');
      if (sysIndex >= 0) messagesForAPI[sysIndex].content = defaultSystemPrompt();
      else messagesForAPI.unshift({role:'system', content: defaultSystemPrompt()});

      // –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –∫–ª—é—á–∞
      if (!OPENAI_API_KEY || OPENAI_API_KEY === "YOUR_API_KEY_HERE") {
        // –ø–æ–∫–∞–∑–∞—Ç–∏ –¥—Ä—É–∂–Ω—î –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –∑ —ñ–Ω—Å—Ç—Ä—É–∫—Ü—ñ—î—é
        addMessageToDOM("‚ö†Ô∏è API key not set. Open API modal (top-right) and paste your key into the code.", 'bot');
        status('');
        return;
      }

      try {
        // –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ v1/chat/completions
        const model = modelSelect.value || 'gpt-3.5-turbo';
        const body = {
          model,
          messages: messagesForAPI.filter(m => m.role !== 'system' ? true : true), // all roles (we want system too)
          temperature: 0.7,
          max_tokens: 1000
        };

        // –ù–∞–¥—Å–∏–ª–∞—î–º–æ –∑–∞–ø–∏—Ç
        const resp = await fetch('https://api.openai.com/v1/chat/completions', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': 'Bearer ' + OPENAI_API_KEY
          },
          body: JSON.stringify(body)
        });

        if (!resp.ok) {
          const textErr = await resp.text();
          throw new Error('HTTP ' + resp.status + ' ‚Äî ' + textErr);
        }

        const data = await resp.json();
        // –ë–µ–∑–ø–µ—á–Ω–∞ –ø–µ—Ä–µ–≤—ñ—Ä–∫–∞
        const content = (data.choices && data.choices[0] && data.choices[0].message && data.choices[0].message.content) || "[no response]";
        appendAndSave('assistant', content);
        addMessageToDOM(content, 'bot');
        status('');
      } catch (err) {
        console.error(err);
        addMessageToDOM("‚ö†Ô∏è Error: " + err.message, 'bot');
        status('');
      }
    }

    // status helper
    function status(t) {
      statusEl.textContent = t || '';
    }

    /***********************
     * Events
     ***********************/
    sendBtn.addEventListener('click', sendMessage);
    userInput.addEventListener('keydown', e => {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        sendMessage();
      }
    });

    document.getElementById('clearBtn').addEventListener('click', () => {
      if (confirm('Clear conversation?')) clearConversation();
    });

    document.getElementById('saveBtn').addEventListener('click', () => {
      const dataStr = JSON.stringify(conversation, null, 2);
      const blob = new Blob([dataStr], {type: 'application/json'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'chatfury_export.json';
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    });

    // Modals
    const aboutBtn = document.getElementById('aboutBtn');
    const apiBtn = document.getElementById('apiBtn');
    const modalBack = document.getElementById('modalBack');
    const apiModalBack = document.getElementById('apiModalBack');

    aboutBtn.addEventListener('click', () => { modalBack.style.display = 'flex'; });
    document.getElementById('closeModal').addEventListener('click', ()=> modalBack.style.display='none');
    modalBack.addEventListener('click', (e)=> { if (e.target === modalBack) modalBack.style.display='none'; });

    apiBtn.addEventListener('click', ()=> { apiModalBack.style.display='flex'; });
    document.getElementById('closeApi').addEventListener('click', ()=> apiModalBack.style.display='none');
    apiModalBack.addEventListener('click', (e)=> { if (e.target === apiModalBack) apiModalBack.style.display='none'; });

    // keyboard focus
    userInput.focus();

    // update language label when typing first char (helps auto-detect)
    userInput.addEventListener('input', () => {
      setTimeout(setLangLabel, 0);
    });

    // Initial render if conversation loaded
    (function initRender() {
      // if conversation contains assistant messages, show them; otherwise add greeting
      if (conversation.length === 0) {
        conversation.push({ role: 'system', content: defaultSystemPrompt() });
        saveConversation();
        renderConversation();
      } else {
        renderConversation();
      }
      updateCount();
    })();
  </script>
</body>
</html>
